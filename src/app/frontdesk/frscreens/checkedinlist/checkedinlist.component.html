<div class="content-body">
  <div class="container-fluid">
 
    <div class="row align-items-end mb-3 gx-3">
      <div class="col-md-2">
        <h5 class="mb-0">Check-In List</h5>
      </div>

      <form [formGroup]="reservationform" class="col-md-8 row gx-3 needs-validation" novalidate>
        <div class="col-md-6">
          <label class="form-label mb-1">From Date</label>
          <input type="date" class="form-control" formControlName="from_date" (change)="on_datechange()">
        </div>
        <div class="col-md-6">
          <label class="form-label mb-1">To Date</label>
          <input type="date" class="form-control" formControlName="to_date" (change)="on_datechange()">
        </div>
      </form>

      <div class="col-md-2 text-end">
        <a href="#/frontdesk/checkinform" class="btn btn-success btn-sm text-white mt-3">
          +Add Walkin
        </a>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <div class="card">

          <div class="card-body">
            <div class="table-responsive">
              <table class="table" datatable [dtOptions]="reservation_datatable" [dtTrigger]="dtTrigger">
                <thead>
                  <tr>
                    <th>Sl No</th>
                    <th>CheckinID</th>
                    <th>BookingID</th>
                    <th>Name &amp; details</th>
                    <th>Check in</th>
                    <th>Check out</th>
                    <th>Room Plan</th>
                    <th>RoomNo</th>
                    <th>OTP</th>
                    <th>View</th>
                    <!-- <th>Check In</th> -->
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let record of booking_list; let i = index">
                    <td>{{ i + 1 }}</td>
                    <td>{{ record.checkinid }}</td>
                    <td>{{ record.booking_id }}</td>
                    <td><a  (click)="view_details(record)">{{ record.guest_name }} {{ record.guest_lastname }}, {{
                      record.guest_mobile }}</a></td>
                    <td>{{ record.check_in | date }}</td>
                    <td>{{ record.check_out | date }}</td>
                    <td>SUPER DELUX DOUBLE OCCUPANCY</td>
                    <td>{{ record.room_name }}</td>
                    <td>{{ record.guests_otp }}</td>
                    <td class="text-center">
                     
                         <i class="fa fa-eye text-primary me-2" style="cursor: pointer; font-size:18px"
                        data-bs-toggle="modal" data-bs-target="#viewDetailsModal" (click)="view_details(record)">
                      </i>&nbsp;&nbsp;

                          <a href="/#/frontdesk/checkinformupdate?chid={{ record.checkinid }}">
                        <i class="fa fa-bed text-danger pointer-class" style="font-size: 20px;"></i>
                        </a>
                    </td>
                    <!-- <td class="text-center">
                      <a href="/#/frontdesk/addreservation?guest_id={{ record.guest_details_id }}">
                        <i class="fa fa-bed text-primary pointer-class" style="cursor: pointer; font-size: 20px;"></i>
                      </a>
                    </td> -->
                  </tr>
                </tbody>
              </table>

            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="modal fade" id="viewDetailsModal" tabindex="-1" aria-labelledby="viewDetailsLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content" style="max-height: 90vh; display: flex; flex-direction: column;">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="viewDetailsLabel" style="color: white;">Guest Booking Info</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body overflow-auto" style="flex: 1 1 auto;">
        <!-- Nav Tabs -->
        <ul class="nav nav-tabs mb-3" id="guestTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabGuest" type="button"
              role="tab">Guest</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabBooking" type="button"
              role="tab">Booking</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabID" type="button"
              role="tab">Identification</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPayment" type="button"
              role="tab">Payments</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabHistory" type="button"
              role="tab">History</button>
          </li>
        </ul>

        <div class="tab-content">
          <!-- GUEST DETAILS -->
          <div class="tab-pane fade show active" id="tabGuest" role="tabpanel">
            <ng-container *ngIf="selected_guest?.guest_details; else noGuestDetails">
            <div class="card shadow-sm p-3">
                        <div class="row mb-2">
                          <div class="col-md-6"><strong>Name:</strong>{{selected_guest.guest_details.guests_name}} </div>
                          <div class="col-md-6"><strong>Mobile:</strong> {{ selected_guest.guest_details.guests_mobile }}
                          </div>
                        </div>
                        <div class="row mb-2">
                          <div class="col-md-6"><strong>Source:</strong> {{ selected_guest.guest_details.booking_from ||
                            '-' }}
                          </div>
                          <div class="col-md-6"><strong>Email:</strong> {{ selected_guest.checkin_info[0].guest_email}}</div>
                        </div>
                        <div class="row mb-2">

                          <div class="col-md-6"><strong>Location:</strong> {{ selected_guest.guest_details.guest_city
                            }}</div>


                          <div class="col-md-6"><strong>Address:</strong> {{ selected_guest.guest_details.address ||
                            '-' }}
                          </div>
                        </div>
                        <div class="row mb-2">
                          <div class="col-md-12">Room OTP:<strong> {{ selected_guest.guest_details.guests_otp
                              }}</strong>
                          </div>
                        </div>
                      </div>
            </ng-container>
            <ng-template #noGuestDetails>
              <p class="text-muted">No guest details available.</p>
            </ng-template>
          </div>

          <!-- Booking Details Tab -->
          <div class="tab-pane fade" id="tabBooking" role="tabpanel">
            <ng-container *ngIf="selected_guest?.checkin_info?.length > 0; else noCheckin">
               <div *ngFor="let checkin of selected_guest?.checkin_info; let i = index"
                        class="border rounded p-3 mb-3">
                        <h6 class="fw-bold mb-3">Booking {{ i + 1 }}</h6>
                        <div class="row mb-2">
                          <div class="col-md-6"><strong>Check-In:</strong> {{ selected_guest.checkin_info[0].check_in | date}}</div>
                          <div class="col-md-6"><strong>Check-Out:</strong> {{ selected_guest.checkin_info[0].check_out | date }}</div>
                        </div>
                        <div class="row mb-2">
                          <div class="col-md-6"><strong>Room Info:</strong> {{ selected_guest.payment_info[0].description || '-' }}</div>
                          <div class="col-md-6"><strong>No.of Nights:</strong> {{ checkin.number_of_nights || '-' }}
                          </div>
                        </div>
                        <div class="row mb-2">
                          <div class="col-md-4"><strong>Adults:</strong> {{ checkin.adults }}</div>
                          <div class="col-md-4"><strong>Child:</strong> {{ checkin.child }}</div>
                        </div>
                        <!-- <div class="d-flex gap-2 mt-2 justify-content-end">
                          <button class="btn btn-danger btn-sm text-white"><i class="fa fa-sign-out-alt me-1"></i>
                            Check-Out</button>
                          <button class="btn btn-warning btn-sm text-white"><i class="fa fa-ban me-1"></i> Cancel
                            Booking</button>
                        </div> -->
                      </div>
            </ng-container>
            <ng-template #noCheckin>
              <p class="text-muted">No booking records found.</p>
            </ng-template>
          </div>

          <!-- IDENTIFICATION -->
          <div class="tab-pane fade" id="tabID" role="tabpanel">
            <ng-container *ngIf="selected_guest?.identification_info?.length; else noID">
              <div class="row">
                <ng-container *ngFor="let doc of selected_guest.identification_info">
                  <div class="col-md-3 mb-3">
                    <div class="card shadow-sm h-100 text-center">
                      <div class="card-body p-2">
                        <p class="fw-semibold mb-2">{{ doc.doc_type === 'idproof' ? 'ID Proof' : 'Photo Proof' }}</p>
                        <a [href]="'http://localhost/newrsmguest/' + doc.guest_document" target="_blank">
                          <img [src]="'http://localhost/newrsmguest/' + doc.guest_document" class="img-fluid rounded"
                            style="height: 150px; object-fit: cover;" />
                        </a>
                      </div>
                    </div>
                  </div>
                </ng-container>
              </div>
            </ng-container>
            <ng-template #noID>
              <p class="text-muted">No identification documents found.</p>
            </ng-template>
          </div>

          <!-- PAYMENTS -->
          <div class="tab-pane fade" id="tabPayment" role="tabpanel">
            <ng-container *ngIf="selected_guest?.payment_info?.length; else noPayments">
                      <div *ngFor="let payment of selected_guest.payment_history" class="card shadow-sm p-3 mb-3">
                        <div class="row">

                          <div class="col-md-6"><strong>Total:</strong> ₹{{ payment.amount_paid }}</div>
                          <div class="col-md-6"><strong>Payment Mode:</strong> {{ payment.payment_mode }}</div>
                          <div class="col-md-6"><strong>Description:</strong> {{ payment.remarks }}</div>
                        </div>
                        <div class="row">
                          <div class="col-md-6"><strong>Paid:</strong> {{ payment.payment_status === 'Success' ? 'Yes' :
                            'No' }}</div>
                        </div>
                      </div>
                    </ng-container>
                    <div class="table-responsive mt-3" *ngIf="selected_guest?.payment_info?.length">
                      <h5 class="mb-2">Mapped Service Payments</h5>
                      <table class="table table-bordered table-sm">
                        <thead class="table-light">
                          <tr>
                            <th>#</th>
                            <th>Source</th>
                            <th>Base Amount (₹)</th>
                            <th>GST %</th>
                            <th>GST Amount (₹)</th>
                            <th>Total (₹)</th>
                            <th>Paid</th>
                            <th>Date</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let item of selected_guest.payment_info; let i = index">
                            <td>{{ i + 1 }}</td>
                            <td>{{ item.description }}</td>
                            <td>{{ item.base_amount }}</td>
                            <td>{{ item.gst_percent }}</td>
                            <td>{{ item.gst_amount }}</td>
                            <td>{{ item.total_amount }}</td>
                            <td>{{ item.is_paid == '1' ? 'Yes' : 'No' }}</td>
                            <td>{{ item.created_at | date: 'short' }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
            <ng-template #noPayments>
              <p class="text-muted">No payment data found.</p>
            </ng-template>
          </div>

          <!-- PAYMENT HISTORY -->
          <div class="tab-pane fade" id="tabHistory" role="tabpanel">
            <ng-container *ngIf="selected_guest?.payment_history?.length; else noHistory">
              <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>#</th>
                      <th>Receipt No</th>
                      <th>Date</th>
                      <th>Mode</th>
                      <th>Amount</th>
                      <th>Reference</th>
                      <th class="text-center"><i class="fa fa-receipt"></i></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let item of selected_guest.payment_history; let i = index">
                      <td>{{ i + 1 }}</td>
                      <td>{{ item.receipt_no }}</td>
                      <td>{{ item.created_at | date: 'yyyy-MM-dd HH:mm' }}</td>
                      <td>{{ item.payment_mode }}</td>
                      <td>₹{{ item.amount_paid }}</td>
                      <td>{{ item.payment_reference }}</td>
                      <td class="text-center text-danger"><a href="/#/receipt?guest_id={{item.guest_master_id}}&rec_id={{item.receipt_no}}" target="_blank"><i class="fa fa-receipt hand"></i></a>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </ng-container>
            <ng-template #noHistory>
              <p class="text-muted">No payment history available.</p>
            </ng-template>
          </div>
        </div>
      </div>


      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>